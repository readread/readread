/*!
 * 本地自动完成
 * 地址：http://10.10.50.7/cStorage
 * 开发日期: 13-11-15
 *
 * 依赖:本地存储框架cStorage, cst
 */
(function(g){if(!g.cst||!g.cst.support||g.cst.autocomplete==="off"){return}var e=g.cst||g.cStorage,h,n,m=g.document,d=m.getElementsByTagName("html")[0],f=m.getElementsByTagName("body")[0],l=e.use("_autoCompleteData",30),b=1000,c=String.prototype.trim?function(o){return String.prototype.trim.call(o)}:function(o){return(o).replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")},a,k=m.addEventListener?function(q,p,o){q.addEventListener(p,o)}:function(q,p,o){q.attachEvent("on"+p,function(){o.call(q)})},j=function(q){var p=q.style.cssText||"",o;q.style.cssText=p+";border-bottom-width:0;";o=q.offsetHeight;q.style.cssText=p;return q.offsetHeight!==o},i=function(o){if(o.preventDefault){o.preventDefault()}else{o.returnValue=false}};h=e.type==="userData";n=h&&parent.location===g.location;a={init:function(){this.createDom();this.findInput();this.positionChangeEvent()},createDom:function(){var p=this,q=this.box=document.createElement("div"),o=this.inner=document.createElement("div");q.id="cst-localautocomplete";if(h){q.innerHTML='<iframe scrolling="no"></iframe>';o.className="cst-localautocomplete-inner"}q.appendChild(o);f.appendChild(q);k(q,"mouseover",function(t){var w=t||g.event,v=w.target||w.srcElement,s=v.tagName,u,r;if(s==="DIV"){return}if(s!=="SPAN"){v=v.parentNode}u=p.list;r=p.index;if(u[r]){u[r].className=""}v.className="cst-localautocomplete-checked";p.index=v.getAttribute("index")-0});k(q,"mousedown",function(r){if(r){r.preventDefault()}else{p.isDown=true}});k(q,"mouseup",function(t){var v=t||g.event,u=v.target||v.srcElement,s=p.currEle,r=p.index;if(u.tagName==="A"){p.removeData(r);s.focus();return}s.value=p.text[r];p.hideBox()})},findInput:function(){var x=this,t=m.getElementsByTagName("input"),q,u,w,p,y;for(q=0,u=t.length;q<u;q++){p=t[q];w=p.getAttribute("type");y=p.getAttribute("autocomplete");if((!w||w.toLowerCase()==="text")&&(!y||y.toLowerCase()!=="off")){p.setAttribute("autocomplete","off");k(p,"focus",s);k(p,"blur",r);k(p,"keydown",v);k(p,"keyup",o)}}function s(){if(!x.isEffective(this)){return}x.currEle=this;x.data=l.get("data")||[]}function r(){if(!x.isEffective(this)){return}if(x.isDown){this.focus();x.isDown=false;return}var A=c(this.value),z=A.length;if(z>1&&z<21){x.updateData(A)}x.hideBox()}function v(B){var E=B||g.event,D,C,z,A;if(!x.isEffective(this)||!x.isShow){return}D=E.keyCode;C=x.list;z=x.index;A=x.size;switch(D){case 40:C[z].className="";C[x.index=(z+1)%A].className="cst-localautocomplete-checked";i(E);break;case 38:C[z].className="";C[x.index=(z-1+A)%A].className="cst-localautocomplete-checked";i(E);break;case 13:this.value=x.text[z];x.hideBox();break}}function o(){if(!x.isEffective(this)||x.valueCache===this.value){return}x.valueCache=this.value;var K=x.currEle,B,C,E,I,D,F,L,H,J,z,A,G;if(K){I=K.value;if(I){D=[];F=[];J=[];z=[];B=x.data;L=0;H=0;for(C=0,E=B.length;C<E&&L<10;C++){A=B[C];if(A===I){continue}G=["<span>",A.replace(I,"<em>"+I+"</em>"),'<a href="javascript:;" hidefocus="true" title="删除"></a></span>'].join("");if(A.indexOf(I)===0){L++;J.push(A);D.push(G)}else{if(A.indexOf(I)>0){H++;z.push(A);F.push(G)}}}if(L+H){if(L<9){D=D.concat(F);J=J.concat(z)}x.text=J;x.showBox(D);return}}x.hideBox()}}},isEffective:function(o){return !o.getAttribute("readonly")&&!o.getAttribute("disabled")},updateData:function(r){var q=this.data,o=q.length,p;for(p=0;p<o;p++){if(q[p]===r){q.splice(p,1);break}}q.unshift(r);if(q.length>b){q.length=b}l.set("data",q)},showBox:function(r){var s=this.box,p=this.inner,u=this.setLayout(r.length),t,q,o;if(!u.size){return}this.size=r.length=u.size;p.innerHTML=r.join("");t=this.list=p.getElementsByTagName("span");for(q=0,o=this.size;q<o;q++){t[q].setAttribute("index",q+"")}t[0].className="cst-localautocomplete-checked";if(h){p.className="cst-localautocomplete-inner cst-localautocomplete-inner-ie";s.style.width="";s.style.width=Math.max(p.offsetWidth,u.width)+"px";p.className="cst-localautocomplete-inner"}this.index=0;this.isShow=true},hideBox:function(){if(!this.isShow){return}this.box.style.left="-99999999px";this.isShow=false;this.valueCache=undefined},setLayout:function(v){var E=this.getEeferenceEle(this.currEle),s=this.box,q=n?2:0,r=2,A=25,B=252,C=275,o=E.offsetHeight,u=E.offsetWidth,z=E.getBoundingClientRect(),t=z.top-q+(d.scrollTop||f.scrollTop),y=Math.max.apply(null,[d.clientHeight&&d.scrollHeight,f.clientHeight,f.scrollHeight,d.clientHeight])-t-o,p=z.left-q+(d.scrollLeft||f.scrollLeft),w=Math.max.apply(null,[d.clientWidth&&d.scrollWidth,f.clientWidth,f.scrollWidth,d.clientWidth])-p-u,x,D=Math.min(10,v);if(B<y){x=t+o;this.showTop=false}else{if(B<t){x=t-D*A-r;this.showTop=true}else{if(t>y){D=Math.min(Math.floor(t/A),v);x=t-D*A-r;this.showTop=true}else{D=Math.min(Math.floor(y/A),v);x=t+o;this.showTop=false}}}if(D){if(w+u>C){s.style.left=p+"px";s.style.right="auto"}else{s.style.left="auto";s.style.right=w+"px"}s.style.top=x+"px";s.style.height=D*A+"px"}return{size:D,width:E.offsetWidth-r}},getEeferenceEle:function(p){var o=0;if(j(p)){return p}for(;o<3;o++){p=p.parentNode;if(j(p)){return p}}return p},removeData:function(q){var w=this.data,u=this.list,p=this.text[q],t,s,o,r=this.size=this.size-1;if(!r){this.hideBox()}else{this.inner.removeChild(u[q]);this.box.style.height=r*25+"px";if(this.index>=r){this.index--}t=this.index;u[t].className="cst-localautocomplete-checked";for(s=q;s<r;s++){u[s].setAttribute("index",s+"")}if(this.showTop){this.setLayout(r)}}this.text.splice(q,1);for(s=0,o=w.length;s<o;s++){if(w[s]===p){w.splice(s,1);break}}l.set("data",w)},positionChangeEvent:function(){var q=this,p,o;k(g,"resize",function(){if(!q.isShow){return}var s=window.innerWidth||d.clientWidth||f.clientWidth,r=window.innerHeight||d.clientHeight||f.clientHeight;if(p!==s||o!==r){p=s;o=r;q.hideBox()}});k(g,"scroll",function(){if(!q.isShow){return}q.setLayout(q.size)})}};k(g,"load",function(){setTimeout(function(){a.init()},500)})})(window);